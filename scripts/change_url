#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================

if [ $multisite -eq 1 ]
then
	echo "A multisite installation of WordPress can't be moved easily. Please have a look at the WordPress codex to learn more about that." >&2
	ynh_die "https://codex.wordpress.org/Moving_WordPress#Moving_WordPress_Multisite"
fi

ynh_script_progression "Updating NGINX web server configuration..."

ynh_config_change_url_nginx

#=================================================
# UPDATE THE DATABASE
#=================================================

ynh_script_progression "Updating database URLs to use new domain..."

# Get the database table prefix
db_prefix=$(grep '^$table_prefix' "$install_dir/wp-config.php" | sed "s/.*'\(.*\)'.*/\1/" )
old_url="https://$old_domain$old_path"
new_url="https://$new_domain$new_path"

guid_wp_posts=$(ynh_mysql_db_shell <<< "SELECT guid FROM ${db_prefix}wp_posts WHERE guid LIKE '%$old_url%';" | tail -n1)
ynh_mysql_db_shell <<< "UPDATE ${db_prefix}wp_posts SET guid = replace(guid, '$old_url','$new_url');"
ynh_script_progression "Updated $guid_wp_posts entries in ${db_prefix}wp_posts table"

urls_wp_posts=$(ynh_mysql_db_shell <<< "SELECT id FROM ${db_prefix}wp_posts WHERE post_content LIKE '%$old_url%';" | tail -n1)
ynh_mysql_db_shell <<< "UPDATE ${db_prefix}wp_posts SET post_content = replace(post_content, '$old_url', '$new_url');"
ynh_script_progression "Updated $urls_wp_posts entries in ${db_prefix}wp_posts table"

urls_wp_postmeta=$(ynh_mysql_db_shell <<< "SELECT meta_value FROM wp_postmeta WHERE meta_value LIKE '%$old_url%';" | tail -n1)
ynh_mysql_db_shell <<< "UPDATE ${db_prefix}wp_postmeta SET meta_value = replace(meta_value,'$old_url','$new_url');"
ynh_script_progression "Updated $urls_wp_postmeta entries in ${db_prefix}wp_postmeta table"

ynh_mysql_db_shell <<< "UPDATE ${db_prefix}options SET option_value='$new_url' WHERE option_name='siteurl'"

ynh_mysql_db_shell <<< "UPDATE ${db_prefix}options SET option_value='$new_url' WHERE option_name='home'"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Change of URL completed for $app"
